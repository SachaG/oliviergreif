---
import Oeuvre from "../../../components/catalogue/Oeuvre.compact.astro";
import {
	capitalizeFirstLetter,
	getInstruments,
	getItemsStaticPaths,
} from "../../../helpers";
import { convertTitle, pluralize } from "../../../helpers";
import { getCatalogue } from "../../../helpers";
import Layout from "../../../layouts/Layout.astro";
import type { WithId } from "../../../types";
import Instruments from "../../../components/catalogue/Instruments.astro";

const { id: currentInstrumentId } = Astro.params;

export function getStaticPaths() {
	return getItemsStaticPaths(
		getInstruments().map(
			(instrument) => ({ id: convertTitle(instrument) }) as WithId,
		),
	);
}

const catalogue = getCatalogue({ instrumentId: currentInstrumentId });
const instruments = getInstruments();
const title = capitalizeFirstLetter(
	instruments.find((i) => convertTitle(i) === currentInstrumentId) || "",
);
const maxNumberOfInstruments = Math.max(
	...catalogue.map((o) => o.instruments?.length || 0),
);
const catalogueByNumberOfInstruments = [...Array(maxNumberOfInstruments)]
	.map((x, count) => ({
		count: count + 1,
		items: catalogue.filter((o) => o.instruments?.length === count + 1),
	}))
	.filter(({ items }) => items.length > 0);
---

<Layout title={`Catalogue (${title})`}>
	<h2>
		Catalogue: {title} ({catalogue.length}
		{pluralize("oeuvre", catalogue.length)})
	</h2>
	<div class="grid">
		<main>
			{
				catalogueByNumberOfInstruments.map(({ count, items }) => (
					<div class="count">
						<h4 class="count-title">
							<span>
								{count} {pluralize("instrument", count)}{" "}
								<span>
									({items.length}{" "}
									{pluralize("oeuvre", items.length)})
								</span>
							</span>
						</h4>
						<div class="items">
							{items.map((oeuvre) => (
								<Oeuvre id={oeuvre.id} />
							))}
						</div>
					</div>
				))
			}
		</main>
		<section class="sidebar">
			<div class="sidebar-contents">
				<Instruments currentInstrumentId={currentInstrumentId} />
			</div>
		</section>
	</div>
</Layout>

<style type="text/scss">
	.count-title {
		position: sticky;
		top: 0px;
		background: #ffffffcc;
		font-size: 2.5rem;
	}
</style>
